################################################################################
# Copyright 2010 Andreas Neustifter (andreas.neustifter@gmail.com)
#
# This file is part of PhotoImport.
#
# PhotoImport is free software: you can redistribute it and/or modify it under
# the terms of the GNU General Public License as published by the Free Software
# Foundation, either version 3 of the License, or (at your option) any later
# version.
#
# PhotoImport is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
# FOR A PARTICULAR PURPOSE. See the GNU General Public License for more
# details.
#
# You should have received a copy of the GNU General Public License along with
# PhotoImport. If not, see <http://www.gnu.org/licenses/>.
################################################################################
""" An extension to the wx.Panel that easily shows images. """
# -*- coding: utf-8 -*-
# generated by wxGlade 0.6.3 on Sun Nov  7 13:00:52 2010

import wx
import pyexiv2
import io
import logging
import ExifHandler

# begin wxGlade: dependencies
# end wxGlade

# begin wxGlade: extracode

# end wxGlade

class ImagePanel(wx.Panel):
    """ An extension to the wx.Panel that easily shows images. """

    def __init__(self, *args, **kwds):
        # begin wxGlade: ImagePanel.__init__
        kwds["style"] = wx.TAB_TRAVERSAL
        wx.Panel.__init__(self, *args, **kwds)

        self.__set_properties()
        self.__do_layout()
        # end wxGlade
        self._imagedata = None
        self._drawdata = None
        self._loadedimage = ""
        self.Bind(wx.EVT_PAINT, self.evt_onpaint, self)

    def __set_properties(self):
        # begin wxGlade: ImagePanel.__set_properties
        pass
        # end wxGlade

    def __do_layout(self):
        # begin wxGlade: ImagePanel.__do_layout
        pass
        # end wxGlade

    def display(self, imagename):
        """ Loads image from preview or file and converts it properly. """
        if self._loadedimage != imagename:
            self._imagedata = ExifHandler.getthumbnail(imagename)

            if self._imagedata is not None:
                self._loadedimage = imagename

        try:
            imagewidth = (float)(self._imagedata.GetWidth())
            imageheigth = (float)(self._imagedata.GetHeight())
            panelwidth, panelheight = self.GetSizeTuple()

            scale = imagewidth/(float)(panelwidth)
            if (imageheigth/panelheight) > scale:
                scale = imageheigth/(float)(panelheight)

            self._drawdata = self._imagedata.Copy()
            self._drawdata.Rescale(imagewidth/scale, imageheigth/scale)

            self.Refresh(True)
        except:
            logging.error("Can not convert image, no preview.")

    def evt_onpaint(self, event):
        """
        This paints the panel.
        """
        try:
            drawingcontext = wx.PaintDC(self)
            if self._imagedata:
                drawingcontext.DrawBitmap(self._drawdata.ConvertToBitmap(), 0, 0)
        except:
            logging.error("Can not display image, no preview.")

# end of class ImagePanel
